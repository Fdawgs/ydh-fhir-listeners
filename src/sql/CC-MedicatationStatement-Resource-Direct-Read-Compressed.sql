WITH medicationStatement_CTE AS (SELECT DISTINCT medstatId, CONCAT(COALESCE(medstatDateassertedDate, ''),'T', COALESCE(medstatDateassertedTime, '')) AS medstatDateasserted, CONCAT(COALESCE(medstatEffectiveStart_Datepart, ''),'T', COALESCE(medstatEffectiveStart_Timepart, '')) AS medstatEffectiveStart, CONCAT(COALESCE(medstatEffectiveEnd_Datepart, ''),'T', COALESCE(medstatEffectiveEnd_Timepart, '')) AS medstatEffectiveEnd, medstatSubjectReference, medstatDosageTimingRepeatDuration, medstatDosageTimingRepeatDurationUnit, medstatDosagePatientinstruction, medstatDosageRouteText, medstatDosageDoseQuantityValue, medstatDosageDoseQuantityUnit, CASE WHEN (CURRENT_TIMESTAMP BETWEEN CAST(medstatEffectiveStart_Datepart AS DATETIME) + CAST(medstatEffectiveStart_Timepart AS DATETIME) AND CAST(medstatEffectiveEnd_Datepart AS DATETIME) + CAST(medstatEffectiveEnd_Timepart AS DATETIME)) AND orderItemStatus != 'Discontinued' THEN 'active' WHEN CURRENT_TIMESTAMP < CAST(medstatEffectiveStart_Datepart AS DATETIME) + CAST(medstatEffectiveStart_Timepart AS DATETIME) AND orderItemStatus != 'Discontinued' THEN 'intended' WHEN CURRENT_TIMESTAMP > CAST(medstatEffectiveEnd_Datepart AS DATETIME) + CAST(medstatEffectiveEnd_Timepart AS DATETIME) AND orderItemStatus != 'Discontinued' THEN 'completed' WHEN orderItemStatus = 'Discontinued' AND orderItemVariance IN ('DATA', 'ERROR') THEN 'entered-in-error' WHEN orderItemStatus = 'Discontinued' THEN 'stopped' END AS medstatStatusCode, medicationId, medicationCodeText, medicationCodeCodingDisplay, medicationCodeCodingCode FROM OPENQUERY([ENYH-PRD-ANALYTICS], 'SELECT DISTINCT REPLACE(oi.OEORI_RowID, ''||'', ''-'') AS medstatId, oi.OEORI_Date AS medstatDateassertedDate, oi.OEORI_TimeOrd AS medstatDateassertedTime, oi.OEORI_SttDat AS medstatEffectiveStart_Datepart, oi.OEORI_SttTim AS medstatEffectiveStart_Timepart, oi.OEORI_EndDate AS medstatEffectiveEnd_Datepart, oi.OEORI_EndTime AS medstatEffectiveEnd_Timepart, oi.OEORI_OEORD_ParRef->OEORD_Adm_DR->PAADM_PAPMI_DR->PAPMI_No AS medstatSubjectReference, oi.OEORI_OEOrdItem2_DR->ITM2_DurationValue AS medstatDosageTimingRepeatDuration, oi.OEORI_OEOrdItem2_DR->ITM2_DurationUnit AS medstatDosageTimingRepeatDurationUnit, oi.OEORI_Instr_DR->PHCIN_Desc1 AS medstatDosagePatientinstruction, oi.OEORI_AdminRoute_DR->ADMR_Desc AS medstatDosageRouteText, oi.OEORI_DoseQty AS medstatDosageDoseQuantityValue, oi.OEORI_Unit_DR->CTUOM_Desc AS medstatDosageDoseQuantityUnit, oi.OEORI_ItemStat_DR->OSTAT_Desc AS orderItemStatus, oi.OEORI_VarianceReason_DR->VR_Code AS orderItemVariance, NULL AS RESOURCE_LINEBREAK, oi.OEORI_ItmMast_DR->ARCIM_Abbrev AS medicationCodeText, REPLACE(oi.OEORI_ItmMast_DR->ARCIM_RowID, ''||'', ''-'') AS medicationId, arcex.EXT_Desc AS medicationCodeCodingDisplay, arcex.EXT_Code AS medicationCodeCodingCode FROM OE_OrdItem oi LEFT JOIN ARC_ItmMast arc ON oi.OEORI_ItmMast_DR = arc.ARCIM_RowId LEFT JOIN ARC_ItemExternalCodes arcex ON arc.ARCIM_RowId = arcex.EXT_ParRef AND EXT_HL7SendingFacility = ''FDB'' AND EXT_HL7SendingApp IN (''AMPP'', ''VMPP'') WHERE oi.OEORI_Categ_DR->ORCAT_Desc IN (''PHARMACY'', ''PHARM'') " + firstParams + " ')) SELECT * FROM medicationStatement_CTE WHERE medstatStatusCode IS NOT NULL " + secondParams + ";